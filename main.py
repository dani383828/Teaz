import os
import logging
import asyncio
from fastapi import FastAPI, Request
from telegram import (
    Update, ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, BotCommand
)
from telegram.ext import (
    Application, CommandHandler, ContextTypes, MessageHandler, filters, CallbackQueryHandler
)

# ---------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ ----------
TOKEN = os.getenv("BOT_TOKEN") or "7084280622:AAGlwBy4FmMM3mc4OjjLQqa00Cg4t3jZNg"
CHANNEL_USERNAME = "@teazvpn"
ADMIN_ID = 5542927340
TRON_ADDRESS = "TJ4xrwKzKjk6FgKfuuqwah3Az5Ur22kJb"
BANK_CARD = "0000 - 0000 - 0000 - 0000"

RENDER_BASE_URL = os.getenv("RENDER_BASE_URL") or "https://teaz.onrender.com"
WEBHOOK_PATH = f"/webhook/{TOKEN}"
WEBHOOK_URL = f"{RENDER_BASE_URL}{WEBHOOK_PATH}"

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)

app = FastAPI()
application = Application.builder().token(TOKEN).build()

import psycopg2
from psycopg2 import pool

DATABASE_URL = os.getenv("DATABASE_URL")

db_pool: pool.ThreadedConnectionPool = None

def init_db_pool():
    global db_pool
    if not DATABASE_URL:
        raise RuntimeError("DATABASE_URL environment variable is not set.")
    db_pool = psycopg2.pool.ThreadedConnectionPool(minconn=1, maxconn=10, dsn=DATABASE_URL)

def close_db_pool():
    global db_pool
    if db_pool:
        db_pool.closeall()
        db_pool = None

def _db_execute_sync(query, params=(), fetch=False, fetchone=False, returning=False):
    conn = None
    cur = None
    try:
        conn = db_pool.getconn()
        cur = conn.cursor()
        cur.execute(query, params)
        result = None
        if returning:
            result = cur.fetchone()[0]
        elif fetchone:
            result = cur.fetchone()
        elif fetch:
            result = cur.fetchall()
        if not query.strip().lower().startswith("select"):
            conn.commit()
        return result
    finally:
        if cur:
            cur.close()
        if conn:
            db_pool.putconn(conn)

async def db_execute(query, params=(), fetch=False, fetchone=False, returning=False):
    return await asyncio.to_thread(_db_execute_sync, query, params, fetch, fetchone, returning)

CREATE_USERS_SQL = """
CREATE TABLE IF NOT EXISTS users (
    user_id BIGINT PRIMARY KEY,
    username TEXT,
    balance BIGINT DEFAULT 0,
    invited_by BIGINT,
    phone TEXT
)
"""
CREATE_PAYMENTS_SQL = """
CREATE TABLE IF NOT EXISTS payments (
    id SERIAL PRIMARY KEY,
    user_id BIGINT,
    amount BIGINT,
    status TEXT,
    type TEXT,
    description TEXT
)
"""
CREATE_SUBSCRIPTIONS_SQL = """
CREATE TABLE IF NOT EXISTS subscriptions (
    id SERIAL PRIMARY KEY,
    user_id BIGINT,
    payment_id INTEGER,
    plan TEXT,
    config TEXT,
    status TEXT DEFAULT 'active'
)
"""

async def create_tables():
    await db_execute(CREATE_USERS_SQL)
    await db_execute(CREATE_PAYMENTS_SQL)
    await db_execute(CREATE_SUBSCRIPTIONS_SQL)

def get_main_keyboard():
    keyboard = [
        [KeyboardButton("ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ"), KeyboardButton("ğŸ’³ Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©")],
        [KeyboardButton("ğŸ Ø§Ø´ØªØ±Ø§Ú© ØªØ³Øª Ø±Ø§ÛŒÚ¯Ø§Ù†"), KeyboardButton("ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ")],
        [KeyboardButton("ğŸ’µ Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø§ÛŒÚ¯Ø§Ù†"), KeyboardButton("ğŸ“‚ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ù†")],
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

def get_balance_keyboard():
    keyboard = [
        [KeyboardButton("Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ"), KeyboardButton("Ø§ÙØ²Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ")],
        [KeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ")]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

def get_back_keyboard():
    return ReplyKeyboardMarkup([[KeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ")]], resize_keyboard=True)

def get_subscription_keyboard():
    keyboard = [
        [KeyboardButton("Û± Ù…Ø§Ù‡Ù‡: Û¹Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†")],
        [KeyboardButton("Û³ Ù…Ø§Ù‡Ù‡: Û²ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†")],
        [KeyboardButton("Û¶ Ù…Ø§Ù‡Ù‡: Û´ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†")],
        [KeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ")]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

async def is_user_member(user_id):
    try:
        member = await application.bot.get_chat_member(CHANNEL_USERNAME, user_id)
        return member.status in ["member", "administrator", "creator"]
    except Exception:
        return False

async def ensure_user(user_id, username, invited_by=None):
    row = await db_execute("SELECT user_id FROM users WHERE user_id = %s", (user_id,), fetchone=True)
    if not row:
        await db_execute(
            "INSERT INTO users (user_id, username, invited_by) VALUES (%s, %s, %s)",
            (user_id, username, invited_by)
        )
        if invited_by and invited_by != user_id:
            inviter = await db_execute("SELECT user_id FROM users WHERE user_id = %s", (invited_by,), fetchone=True)
            if inviter:
                await add_balance(invited_by, 25000)

async def save_user_phone(user_id, phone):
    await db_execute("UPDATE users SET phone = %s WHERE user_id = %s", (phone, user_id))

async def get_user_phone(user_id):
    row = await db_execute("SELECT phone FROM users WHERE user_id = %s", (user_id,), fetchone=True)
    return row[0] if row else None

async def add_balance(user_id, amount):
    await db_execute("UPDATE users SET balance = COALESCE(balance,0) + %s WHERE user_id = %s", (amount, user_id))

async def get_balance(user_id):
    row = await db_execute("SELECT balance FROM users WHERE user_id = %s", (user_id,), fetchone=True)
    return int(row[0]) if row and row[0] is not None else 0

async def add_payment(user_id, amount, ptype, description=""):
    query = "INSERT INTO payments (user_id, amount, status, type, description) VALUES (%s, %s, 'pending', %s, %s) RETURNING id"
    new_id = await db_execute(query, (user_id, amount, ptype, description), returning=True)
    return int(new_id)

async def add_subscription(user_id, payment_id, plan):
    await db_execute(
        "INSERT INTO subscriptions (user_id, payment_id, plan, status) VALUES (%s, %s, %s, 'active')",
        (user_id, payment_id, plan)
    )

async def update_subscription_config(payment_id, config):
    await db_execute("UPDATE subscriptions SET config = %s WHERE payment_id = %s", (config, payment_id))

async def update_payment_status(payment_id, status):
    await db_execute("UPDATE payments SET status = %s WHERE id = %s", (status, payment_id))

async def get_user_subscriptions(user_id):
    rows = await db_execute("SELECT id, plan, config, status, payment_id FROM subscriptions WHERE user_id = %s", (user_id,), fetch=True)
    return rows

user_states = {}

async def set_bot_commands():
    commands = [BotCommand(command="/start", description="Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª")]
    await application.bot.set_my_commands(commands)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    username = user.username or ""

    if not await is_user_member(user_id):
        kb = [[InlineKeyboardButton("ğŸ“¢ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„", url=f"https://t.me/{CHANNEL_USERNAME.replace('@','')}")]]
        await update.message.reply_text(
            "âŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§ØªØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ù…Ø§ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ù…Ø¬Ø¯Ø¯ /start Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.",
            reply_markup=InlineKeyboardMarkup(kb)
        )
        return

    invited_by = context.user_data.get("invited_by")
    await ensure_user(user_id, username, invited_by)

    phone = await get_user_phone(user_id)
    if phone:
        await update.message.reply_text(
            f"ğŸŒ Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ VPN Ù…Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\nØ´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø´Ù…Ø§: {phone}\nÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
            reply_markup=get_main_keyboard()
        )
        user_states.pop(user_id, None)
        return

    contact_keyboard = ReplyKeyboardMarkup(
        [[KeyboardButton("Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³", request_contact=True)]], resize_keyboard=True, one_time_keyboard=True
    )
    await update.message.reply_text(
        "âœ… Ù„Ø·ÙØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
        reply_markup=contact_keyboard
    )
    user_states[user_id] = "awaiting_contact"

async def contact_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_states.get(user_id) != "awaiting_contact":
        return
    contact = update.message.contact
    if contact is None or contact.user_id != user_id:
        await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")
        return

    phone_number = contact.phone_number
    await save_user_phone(user_id, phone_number)

    await context.bot.send_message(
        chat_id=ADMIN_ID,
        text=f"ğŸ“ Ú©Ø§Ø±Ø¨Ø± {user_id} (@{update.effective_user.username or 'NoUsername'}) Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯:\n{phone_number}"
    )

    row = await db_execute("SELECT invited_by FROM users WHERE user_id = %s", (user_id,), fetchone=True)
    invited_by = row[0] if row and row[0] else None
    if invited_by and invited_by != user_id:
        inviter_exists = await db_execute("SELECT user_id FROM users WHERE user_id = %s", (invited_by,), fetchone=True)
        if inviter_exists:
            await context.bot.send_message(
                chat_id=invited_by,
                text=f"ğŸ‰ Ø¯ÙˆØ³Øª Ø´Ù…Ø§ (@{update.effective_user.username or 'NoUsername'}) Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø±Ø§Ø­Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ø±Ø¯!\nğŸ’° Û²Ûµ,Û°Û°Û° ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯."
            )

    await update.message.reply_text(
        "ğŸŒ Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ VPN Ù…Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\nÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=get_main_keyboard()
    )
    user_states.pop(user_id, None)

async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text if update.message.text else ""

    # Ø§Ú¯Ø± Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø¨ÙˆØ¯ Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ÙÛŒØ´ØŒ ÙˆØ¶Ø¹ÛŒØª Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù† Ùˆ Ù…Ù†Ùˆ Ø±Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
    if text == "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ":
        if user_states.get(user_id, "").startswith("awaiting_deposit_receipt_") or \
           user_states.get(user_id, "").startswith("awaiting_subscription_receipt_"):
            user_states.pop(user_id, None)
            await update.message.reply_text("ğŸŒ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ:", reply_markup=get_main_keyboard())
            return

        await update.message.reply_text("ğŸŒ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ:", reply_markup=get_main_keyboard())
        user_states.pop(user_id, None)
        return

    if update.message.photo or update.message.document or update.message.text:
        state = user_states.get(user_id)
        if state and (state.startswith("awaiting_deposit_receipt_") or state.startswith("awaiting_subscription_receipt_")):
            try:
                payment_id = int(state.split("_")[-1])
            except:
                payment_id = None

            if payment_id:
                payment = await db_execute("SELECT amount, type FROM payments WHERE id = %s", (payment_id,), fetchone=True)
                if payment:
                    amount, ptype = payment
                    caption = f"ğŸ’³ ÙÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id} (@{update.effective_user.username or 'NoUsername'}):\n"
                    caption += f"Ù…Ø¨Ù„Øº: {amount}\nÙ†ÙˆØ¹: {'Ø§ÙØ²Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ' if ptype == 'increase_balance' else 'Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©'}"

                    keyboard = InlineKeyboardMarkup([
                        [
                            InlineKeyboardButton("âœ… ØªØ§ÛŒÛŒØ¯", callback_data=f"approve_{payment_id}"),
                            InlineKeyboardButton("âŒ Ø±Ø¯", callback_data=f"reject_{payment_id}")
                        ]
                    ])

                    if update.message.photo:
                        file_id = update.message.photo[-1].file_id
                        await context.bot.send_photo(chat_id=ADMIN_ID, photo=file_id, caption=caption, reply_markup=keyboard)
                    else:
                        doc_id = update.message.document.file_id
                        await context.bot.send_document(chat_id=ADMIN_ID, document=doc_id, caption=caption, reply_markup=keyboard)

                    await update.message.reply_text("âœ… ÙÛŒØ´ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ØŒ Ù„Ø·ÙØ§ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ø¨Ø§Ø´ÛŒØ¯.", reply_markup=get_main_keyboard())
                    user_states.pop(user_id, None)
                    return
        elif state and state.startswith("awaiting_config_"):
            try:
                payment_id = int(state.split("_")[-1])
            except:
                payment_id = None

            if payment_id:
                payment = await db_execute("SELECT user_id, description FROM payments WHERE id = %s", (payment_id,), fetchone=True)
                if payment:
                    buyer_id, description = payment
                    if update.message.text:
                        config = update.message.text
                        await update_subscription_config(payment_id, config)
                        await context.bot.send_message(
                            chat_id=buyer_id,
                            text=f"âœ… Ú©Ø§Ù†ÙÛŒÚ¯ Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ ({description})\nÚ©Ø¯ Ø®Ø±ÛŒØ¯: #{payment_id}\nØ¯Ø±ÛŒØ§ÙØª Ø´Ø¯:\n```\n{config}\n```",
                            parse_mode="Markdown"
                        )
                        await update.message.reply_text("âœ… Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ø®Ø±ÛŒØ¯Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.", reply_markup=None)
                        user_states.pop(user_id, None)
                    else:
                        await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§ Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ØªÙ† Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")
                    return

    if text == "ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ":
        await update.message.reply_text("ğŸ’° Ø¨Ø®Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ:\nÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_balance_keyboard())
        return

    if text == "Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ":
        bal = await get_balance(user_id)
        await update.message.reply_text(f"ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§: {bal} ØªÙˆÙ…Ø§Ù†", reply_markup=get_balance_keyboard())
        return

    if text == "Ø§ÙØ²Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ":
        await update.message.reply_text("ğŸ’³ Ù„Ø·ÙØ§ Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=get_back_keyboard())
        user_states[user_id] = "awaiting_deposit_amount"
        return

    if user_states.get(user_id) == "awaiting_deposit_amount":
        if text.isdigit():
            amount = int(text)
            payment_id = await add_payment(user_id, amount, "increase_balance")
            await update.message.reply_text(
                f"Ù„Ø·ÙØ§ {amount} ØªÙˆÙ…Ø§Ù† ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯ Ùˆ ÙÛŒØ´ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\nğŸ’ {TRON_ADDRESS}\nÛŒØ§\nğŸ¦ {BANK_CARD}",
                reply_markup=get_back_keyboard()
            )
            user_states[user_id] = f"awaiting_deposit_receipt_{payment_id}"
        else:
            await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
        return

    if text == "ğŸ’³ Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©":
        await update.message.reply_text("ğŸ’³ Ù¾Ù„Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_subscription_keyboard())
        return

    if text in ["Û± Ù…Ø§Ù‡Ù‡: Û¹Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†", "Û³ Ù…Ø§Ù‡Ù‡: Û²ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†", "Û¶ Ù…Ø§Ù‡Ù‡: Û´ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†"]:
        mapping = {
            "Û± Ù…Ø§Ù‡Ù‡: Û¹Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†": 90000,
            "Û³ Ù…Ø§Ù‡Ù‡: Û²ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†": 250000,
            "Û¶ Ù…Ø§Ù‡Ù‡: Û´ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†": 450000
        }
        amount = mapping[text]
        payment_id = await add_payment(user_id, amount, "buy_subscription", description=text)
        await add_subscription(user_id, payment_id, text)
        await update.message.reply_text(
            f"Ù„Ø·ÙØ§ {amount} ØªÙˆÙ…Ø§Ù† ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯ Ùˆ ÙÛŒØ´ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\nğŸ’ {TRON_ADDRESS}\nÛŒØ§\nğŸ¦ {BANK_CARD}",
            reply_markup=get_back_keyboard()
        )
        user_states[user_id] = f"awaiting_subscription_receipt_{payment_id}"
        return

    if text == "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ":
        await update.message.reply_text(
            f"Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒØŒ Ø¨Ù‡ Ø¢ÛŒâ€ŒØ¯ÛŒ Ø²ÛŒØ± Ù¾ÛŒØ§Ù… Ø¯Ù‡ÛŒØ¯:\n@SupportBot\nÛŒØ§ Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯."
        )
        return

    if text == "ğŸ’µ Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø§ÛŒÚ¯Ø§Ù†":
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø§ÛŒÚ¯Ø§Ù† (Ù…Ø«Ù„Ø§ Û²Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†)
        await add_balance(user_id, 20000)
        await update.message.reply_text("ğŸ‰ Û²Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù† Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.", reply_markup=get_main_keyboard())
        return

    if text == "ğŸ“‚ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ù†":
        subs = await get_user_subscriptions(user_id)
        if not subs:
            await update.message.reply_text("Ø´Ù…Ø§ Ù‡ÛŒÚ† Ø§Ø´ØªØ±Ø§Ú©ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.", reply_markup=get_main_keyboard())
        else:
            msg = "Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§:\n"
            for sid, plan, config, status, payment_id in subs:
                msg += f"- {plan} ({status})\n"
            await update.message.reply_text(msg, reply_markup=get_main_keyboard())
        return

    # Default fallback
    await update.message.reply_text("Ù„Ø·ÙØ§ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.", reply_markup=get_main_keyboard())

async def callback_query_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    data = query.data

    if not str(user_id) == str(ADMIN_ID):
        await query.answer("Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return

    if data.startswith("approve_"):
        payment_id = int(data.split("_")[1])
        payment = await db_execute("SELECT user_id, amount, type FROM payments WHERE id = %s", (payment_id,), fetchone=True)
        if payment:
            payer_id, amount, ptype = payment
            await update_payment_status(payment_id, "approved")
            if ptype == "increase_balance":
                await add_balance(payer_id, amount)
            await query.edit_message_reply_markup(reply_markup=None)
            await query.answer("Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.")

            await application.bot.send_message(
                chat_id=payer_id,
                text="âœ… ÙÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯ Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø±Ø¯ÛŒØ¯."
            )
        else:
            await query.answer("Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.", show_alert=True)

    elif data.startswith("reject_"):
        payment_id = int(data.split("_")[1])
        payment = await db_execute("SELECT user_id FROM payments WHERE id = %s", (payment_id,), fetchone=True)
        if payment:
            payer_id = payment[0]
            await update_payment_status(payment_id, "rejected")
            await query.edit_message_reply_markup(reply_markup=None)
            await query.answer("Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø¯ Ø´Ø¯.")

            await application.bot.send_message(
                chat_id=payer_id,
                text="âŒ ÙÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ Ø±Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯."
            )
        else:
            await query.answer("Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.", show_alert=True)

@app.on_event("startup")
async def on_startup():
    init_db_pool()
    await create_tables()
    await set_bot_commands()
    await application.bot.set_webhook(WEBHOOK_URL)
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.CONTACT, contact_handler))
    application.add_handler(MessageHandler(filters.TEXT | filters.PHOTO | filters.Document.ALL, message_handler))
    application.add_handler(CallbackQueryHandler(callback_query_handler))
    await application.start()
    await application.updater.start_polling()  # ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ pollingØŒ Ø¯Ø± ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯

@app.on_event("shutdown")
async def on_shutdown():
    await application.stop()
    close_db_pool()

@app.post(WEBHOOK_PATH)
async def telegram_webhook(request: Request):
    data = await request.json()
    update = Update.de_json(data, application.bot)
    await application.update_queue.put(update)
    return {"ok": True}
