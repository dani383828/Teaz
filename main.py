import logging
import sqlite3
import re
import traceback
from fastapi import FastAPI, Request
from telegram import (
    Update, ReplyKeyboardMarkup, KeyboardButton,
    InlineKeyboardMarkup, InlineKeyboardButton
)
from telegram.ext import (
    Application, CommandHandler, ContextTypes,
    MessageHandler, filters, CallbackQueryHandler
)

# ======== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª ========
TOKEN = "7084280622:AAGlwBy4FmMM3mc4OjjLQqa00Cg4t3jJzNg"
CHANNEL_USERNAME = "@teazvpn"
ADMIN_ID = 5542927340
TRON_ADDRESS = "TJ4xrwKJzKjk6FgKfuuqwah3Az5Ur22kJb"
BANK_CARD = "0000 - 0000 - 0000 - 0000"

WEBHOOK_PATH = f"/webhook/{TOKEN}"
WEBHOOK_URL = f"https://teaz.onrender.com{WEBHOOK_PATH}"

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)

app = FastAPI()
application = Application.builder().token(TOKEN).build()

conn = sqlite3.connect("vpnbot.db", check_same_thread=False)
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS users(
    user_id INTEGER PRIMARY KEY,
    username TEXT,
    balance INTEGER DEFAULT 0,
    invited_by INTEGER,
    phone TEXT DEFAULT NULL
)
""")
cursor.execute("""
CREATE TABLE IF NOT EXISTS payments(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    amount INTEGER,
    status TEXT,
    type TEXT,
    description TEXT
)
""")
conn.commit()

def get_main_keyboard():
    keyboard = [
        [KeyboardButton("ðŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ"), KeyboardButton("ðŸ’³ Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©")],
        [KeyboardButton("ðŸŽ Ø§Ø´ØªØ±Ø§Ú© ØªØ³Øª Ø±Ø§ÛŒÚ¯Ø§Ù†"), KeyboardButton("ðŸ“ž Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ")],
        [KeyboardButton("ðŸ’µ Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø§ÛŒÚ¯Ø§Ù†"), KeyboardButton("ðŸ“‚ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ù†")],
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

def get_balance_keyboard():
    keyboard = [
        [KeyboardButton("Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ"), KeyboardButton("Ø§ÙØ²Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ")],
        [KeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ")]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

def get_back_keyboard():
    return ReplyKeyboardMarkup([[KeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ")]], resize_keyboard=True)

def get_subscription_keyboard():
    keyboard = [
        [KeyboardButton("Û± Ù…Ø§Ù‡Ù‡: Û¹Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†")],
        [KeyboardButton("Û³ Ù…Ø§Ù‡Ù‡: Û²ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†")],
        [KeyboardButton("Û¶ Ù…Ø§Ù‡Ù‡: Û´ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†")],
        [KeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ")]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

def ensure_user(user_id, username, invited_by=None):
    cursor.execute("SELECT user_id FROM users WHERE user_id=?", (user_id,))
    if cursor.fetchone() is None:
        cursor.execute("INSERT INTO users(user_id, username, invited_by) VALUES (?, ?, ?)", (user_id, username, invited_by))
        conn.commit()

def save_user_phone(user_id, phone):
    cursor.execute("UPDATE users SET phone=? WHERE user_id=?", (phone, user_id))
    conn.commit()

def get_user_phone(user_id):
    cursor.execute("SELECT phone FROM users WHERE user_id=?", (user_id,))
    res = cursor.fetchone()
    return res[0] if res else None

def add_balance(user_id, amount):
    cursor.execute("UPDATE users SET balance = balance + ? WHERE user_id=?", (amount, user_id))
    conn.commit()

def get_balance(user_id):
    cursor.execute("SELECT balance FROM users WHERE user_id=?", (user_id,))
    res = cursor.fetchone()
    return res[0] if res else 0

def add_payment(user_id, amount, ptype, description=""):
    cursor.execute(
        "INSERT INTO payments(user_id, amount, status, type, description) VALUES (?, ?, 'pending', ?, ?)",
        (user_id, amount, ptype, description)
    )
    conn.commit()
    return cursor.lastrowid

def update_payment_status(payment_id, status):
    cursor.execute("UPDATE payments SET status=? WHERE id=?", (status, payment_id))
    conn.commit()

def get_pending_payments():
    cursor.execute("SELECT id, user_id, amount, type, description FROM payments WHERE status='pending'")
    return cursor.fetchall()

async def is_user_member(user_id):
    try:
        member = await application.bot.get_chat_member(CHANNEL_USERNAME, user_id)
        return member.status in ["member", "administrator", "creator"]
    except Exception as e:
        logging.error(f"Error checking membership: {e}")
        return False

user_states = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    username = user.username or ""

    if not await is_user_member(user_id):
        kb = [[InlineKeyboardButton("ðŸ“¢ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„", url=f"https://t.me/{CHANNEL_USERNAME.replace('@','')}")]]
        await update.message.reply_text(
            "âŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§ØªØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ù…Ø§ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ù…Ø¬Ø¯Ø¯ /start Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.",
            reply_markup=InlineKeyboardMarkup(kb)
        )
        return

    invited_by = context.user_data.get("invited_by")
    ensure_user(user_id, username, invited_by)

    phone = get_user_phone(user_id)
    if phone:
        await update.message.reply_text(
            f"ðŸŒ Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ VPN Ù…Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\nØ´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø´Ù…Ø§: {phone}\nÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
            reply_markup=get_main_keyboard()
        )
        user_states.pop(user_id, None)
        return

    contact_keyboard = ReplyKeyboardMarkup(
        [[KeyboardButton("Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³", request_contact=True)]],
        resize_keyboard=True, one_time_keyboard=True
    )
    await update.message.reply_text(
        "âœ… Ù„Ø·ÙØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
        reply_markup=contact_keyboard
    )
    user_states[user_id] = "awaiting_contact"

async def contact_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_states.get(user_id) != "awaiting_contact":
        return

    contact = update.message.contact
    if contact is None or contact.user_id != user_id:
        await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")
        return

    phone_number = contact.phone_number
    save_user_phone(user_id, phone_number)

    await application.bot.send_message(
        chat_id=ADMIN_ID,
        text=f"ðŸ“ž Ú©Ø§Ø±Ø¨Ø± {user_id} (@{update.effective_user.username or 'NoUsername'}) Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯:\n{phone_number}"
    )

    await update.message.reply_text(
        "ðŸŒ Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ VPN Ù…Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\nÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=get_main_keyboard()
    )
    user_states.pop(user_id, None)

async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text

    logging.info(f"Received message from {user_id}: {text}")
    logging.info(f"user_states[{user_id}] = {user_states.get(user_id)}")

    if text == "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ":
        await update.message.reply_text("ðŸŒ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ:", reply_markup=get_main_keyboard())
        user_states.pop(user_id, None)
        return

    if text == "ðŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ":
        await update.message.reply_text("ðŸ’° Ø¨Ø®Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ:\nÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_balance_keyboard())
        return

    if text == "Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ":
        bal = get_balance(user_id)
        await update.message.reply_text(f"ðŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§: {bal} ØªÙˆÙ…Ø§Ù†", reply_markup=get_balance_keyboard())
        return

    if text == "Ø§ÙØ²Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ":
        await update.message.reply_text(
            "ðŸ’³ Ù„Ø·ÙØ§ Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 50000):",
            reply_markup=get_back_keyboard()
        )
        user_states[user_id] = "awaiting_deposit_amount"
        return

    if user_states.get(user_id) == "awaiting_deposit_amount":
        if text.isdigit():
            amount = int(text)
            payment_id = add_payment(user_id, amount, "increase_balance")
            await update.message.reply_text(
                f"Ù„Ø·ÙØ§ Ù…Ø¨Ù„Øº {amount} ØªÙˆÙ…Ø§Ù† Ø±Ø§ Ø¨Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯ Ùˆ Ø¹Ú©Ø³ ÙÛŒØ´ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
                f"ðŸ”– Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª: #{payment_id}\n\n"
                f"ðŸ’Ž Ø¢Ø¯Ø±Ø³ ØªØ±ÙˆÙ†: `{TRON_ADDRESS}`\n"
                f"ðŸ¦ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: `{BANK_CARD}`\n\n"
                "Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ØŒ Ø§Ø¯Ù…ÛŒÙ† Ø¢Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ§ÛŒÛŒØ¯ ÛŒØ§ Ø±Ø¯ Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯.",
                parse_mode="Markdown",
                reply_markup=get_back_keyboard()
            )
            user_states[user_id] = f"awaiting_deposit_receipt_{payment_id}"
        else:
            await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§ ÙÙ‚Ø· Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø¨Ø²Ù†ÛŒØ¯.")
        return

    if text == "ðŸ’³ Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©":
        await update.message.reply_text("ðŸ’³ Ù„Ø·ÙØ§ Ù¾Ù„Ù† Ø§Ø´ØªØ±Ø§Ú© Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_subscription_keyboard())
        return

    if text in ["Û± Ù…Ø§Ù‡Ù‡: Û¹Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†", "Û³ Ù…Ø§Ù‡Ù‡: Û²ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†", "Û¶ Ù…Ø§Ù‡Ù‡: Û´ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†"]:
        mapping = {
            "Û± Ù…Ø§Ù‡Ù‡: Û¹Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†": 90000,
            "Û³ Ù…Ø§Ù‡Ù‡: Û²ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†": 250000,
            "Û¶ Ù…Ø§Ù‡Ù‡: Û´ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†": 450000
        }
        amount = mapping[text]
        payment_id = add_payment(user_id, amount, "buy_subscription", description=text)
        await update.message.reply_text(
            f"Ù„Ø·ÙØ§ Ù…Ø¨Ù„Øº {amount} ØªÙˆÙ…Ø§Ù† Ø±Ø§ Ø¨Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯ Ùˆ Ø¹Ú©Ø³ ÙÛŒØ´ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n"
            f"ðŸ”– Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª: #{payment_id}\n\n"
            f"ðŸ’Ž Ø¢Ø¯Ø±Ø³ ØªØ±ÙˆÙ†: `{TRON_ADDRESS}`\n"
            f"ðŸ¦ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: `{BANK_CARD}`\n\n"
            "Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ØŒ Ø§Ø¯Ù…ÛŒÙ† Ø¢Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ§ÛŒÛŒØ¯ ÛŒØ§ Ø±Ø¯ Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯.\n"
            "Ø¯Ø± ØµÙˆØ±Øª ØªØ§ÛŒÛŒØ¯ØŒ Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ§ Û± Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯ Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
            parse_mode="Markdown",
            reply_markup=get_back_keyboard()
        )
        user_states[user_id] = f"awaiting_subscription_receipt_{payment_id}"
        return

    if text == "ðŸŽ Ø§Ø´ØªØ±Ø§Ú© ØªØ³Øª Ø±Ø§ÛŒÚ¯Ø§Ù†":
        await update.message.reply_text("ðŸŽ Ø§Ø´ØªØ±Ø§Ú© ØªØ³Øª Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.", reply_markup=get_main_keyboard())
        return

    if text == "ðŸ“ž Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ":
        await update.message.reply_text("ðŸ“ž Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: https://t.me/teazadmin", reply_markup=get_main_keyboard())
        return

    if text == "ðŸ’µ Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø§ÛŒÚ¯Ø§Ù†":
        invite_link = f"https://t.me/teazvpn_bot?start={user_id}"
        await update.message.reply_text(
            f"ðŸ’µ Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù†:\n{invite_link}\n\n"
            "Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø¹ÙˆØª Ù…ÙˆÙÙ‚ØŒ Û²Ûµ,Û°Û°Û° ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
            reply_markup=get_main_keyboard()
        )
        return

    if text == "ðŸ“‚ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ù†":
        await update.message.reply_text("ðŸ“‚ Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø§Ø´ØªØ±Ø§Ú©ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.", reply_markup=get_main_keyboard())
        return

    # ======= Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† (Ø¹Ú©Ø³/ÙØ§ÛŒÙ„) =======
    # Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ§Ù… Ø¹Ú©Ø³/ÙØ§ÛŒÙ„
    if update.message.photo or update.message.document:
        payment_id = None

        # Ø§ÙˆÙ„ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒÙ… Ø¢ÛŒØ§ Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ Ù‡Ø³ØªÛŒÙ…ØŸ
        state = user_states.get(user_id)
        if state and (state.startswith("awaiting_deposit_receipt_") or state.startswith("awaiting_subscription_receipt_")):
            payment_id = int(state.split("_")[-1])

        # Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ù…Ù†ØªØ¸Ø± Ù†Ø¨ÙˆØ¯ØŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒÙ… Ù¾ÛŒØ§Ù… Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ù‡Ø³Øª Ùˆ Payment ID Ø±Ø§ Ø§Ø² Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø´Ø¯Ù‡ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†ÛŒÙ…
        elif update.message.reply_to_message and update.message.reply_to_message.text:
            # Ù†Ù…ÙˆÙ†Ù‡ Ù…ØªÙ† Ø­Ø§ÙˆÛŒ Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª: "Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª: #123"
            match = re.search(r"Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª[:\s]*#(\d+)", update.message.reply_to_message.text)
            if match:
                payment_id = int(match.group(1))

        if payment_id:
            payment = cursor.execute("SELECT user_id, amount, type FROM payments WHERE id=?", (payment_id,)).fetchone()
            if not payment:
                await update.message.reply_text("âš ï¸ Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.")
                return
            pay_user_id, amount, ptype = payment

            if pay_user_id != user_id:
                await update.message.reply_text("âš ï¸ Ø§ÛŒÙ† ÙÛŒØ´ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø´Ù…Ø§ Ù†ÛŒØ³Øª.")
                return

            caption = f"ðŸ’³ ÙÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id}:\nÙ…Ø¨Ù„Øº: {amount}\nÙ†ÙˆØ¹: {'Ø§ÙØ²Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ' if ptype == 'increase_balance' else 'Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©'}"

            keyboard = InlineKeyboardMarkup([
                [
                    InlineKeyboardButton("âœ… ØªØ§ÛŒÛŒØ¯", callback_data=f"approve_{payment_id}"),
                    InlineKeyboardButton("âŒ Ø±Ø¯", callback_data=f"reject_{payment_id}")
                ]
            ])

            try:
                await application.bot.send_message(chat_id=ADMIN_ID, text="ðŸ”” ÛŒÚ© ÙÛŒØ´ Ø¬Ø¯ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ØŒ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...")

                if update.message.photo:
                    file_id = update.message.photo[-1].file_id
                    await application.bot.send_photo(
                        chat_id=ADMIN_ID,
                        photo=file_id,
                        caption=caption,
                        reply_markup=keyboard
                    )
                elif update.message.document:
                    doc_id = update.message.document.file_id
                    await application.bot.send_document(
                        chat_id=ADMIN_ID,
                        document=doc_id,
                        caption=caption,
                        reply_markup=keyboard
                    )
                await update.message.reply_text(
                    "âœ… ÙÛŒØ´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ØŒ Ù„Ø·ÙØ§ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ø¨Ø§Ø´ÛŒØ¯.",
                    reply_markup=get_main_keyboard()
                )
                # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ú©Ø§Ø±Ø¨Ø±
                user_states.pop(user_id, None)
            except Exception as e:
                logging.error(f"Error sending payment receipt to admin: {e}")
                logging.error(traceback.format_exc())
                await update.message.reply_text(
                    "âš ï¸ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§ Ø¨Ø¹Ø¯Ø§ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.",
                    reply_markup=get_main_keyboard()
                )
            return

    await update.message.reply_text("âš ï¸ Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.", reply_markup=get_main_keyboard())

async def admin_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    await query.answer()

    if data.startswith("approve_") or data.startswith("reject_"):
        if update.effective_user.id != ADMIN_ID:
            await query.message.reply_text("âš ï¸ Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø± Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
            return

        payment_id = int(data.split("_")[1])
        payment = cursor.execute("SELECT user_id, amount, type FROM payments WHERE id=?", (payment_id,)).fetchone()
        if not payment:
            await query.message.reply_text("âš ï¸ Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return
        user_id, amount, ptype = payment

        if data.startswith("approve_"):
            update_payment_status(payment_id, "approved")
            if ptype == "increase_balance":
                add_balance(user_id, amount)
                await application.bot.send_message(user_id, f"ðŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯ Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ {amount} ØªÙˆÙ…Ø§Ù† Ø§ÙØ²Ø§ÛŒØ´ ÛŒØ§ÙØª.")
            elif ptype == "buy_subscription":
                await application.bot.send_message(user_id,
                    "âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.\n"
                    "Ú©Ø§Ù†ÙÛŒÚ¯ Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ§ Û± Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯."
                )
            await query.message.edit_reply_markup(None)
            await query.message.reply_text("âœ… Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.")

        elif data.startswith("reject_"):
            update_payment_status(payment_id, "rejected")
            await application.bot.send_message(user_id, "âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ Ø±Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.")
            await query.message.edit_reply_markup(None)
            await query.message.reply_text("âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø¯ Ø´Ø¯.")

async def start_with_param(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    username = user.username or ""
    args = context.args

    if args and len(args) > 0:
        invited_by = None
        try:
            invited_by = int(args[0])
        except:
            pass
        context.user_data["invited_by"] = invited_by

    await start(update, context)

application.add_handler(CommandHandler("start", start_with_param))
application.add_handler(MessageHandler(filters.CONTACT, contact_handler))
application.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), message_handler))
application.add_handler(CallbackQueryHandler(admin_callback_handler))

@app.post(WEBHOOK_PATH)
async def telegram_webhook(request: Request):
    data = await request.json()
    update = Update.de_json(data, application.bot)
    await application.update_queue.put(update)
    return {"ok": True}

@app.on_event("startup")
async def on_startup():
    await application.initialize()
    await application.start()
    await application.bot.set_webhook(url=WEBHOOK_URL)
    print("âœ… Webhook set:", WEBHOOK_URL)

@app.on_event("shutdown")
async def on_shutdown():
    await application.stop()
    await application.shutdown()
